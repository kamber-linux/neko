#!/bin/sh

# include files
. common/neko_msg
for file in prepare fetch check extract patch build
do
	. common/steps/neko_do_${file}
done

# Check for permissions
user_id=$(id | cut -d' ' -f1 | sed 's/uid=//;s/(.*//')
[ "${user_id}" = 0 ] && perms="root" || perms="anon"

case "${1}" in
	"pkg")
		do_prepare "${2}"
		[ -d "${wrksrc}" ] && rm -rf "${wrksrc}"
		for step in fetch check extract patch build
		do
			do_${step} "${2}"
		done
		;;
	"em" | "emerge")
		[ "${perms}" = anon ] && neko_msg error "You must have root permissions to emerge packages" && exit 1;
		. common/steps/neko_do_install
		for step in prepare fetch check extract patch build install
		do
			do_${step} "${2}"
		done
		;;
	"clean")
		neko_msg normal "Cleaning master directory..."
		rm -rf master/* &&
			neko_msg success "Successfully cleaned master directory!" ||
			{ neko_msg error "Failed to clean master directory!" && exit 1; }
		;;
	"uninstall")
		do_prepare "${2}"
		cd .. || exit 1
		. common/steps/neko_do_uninstall
		cd master || exit 1
		[ ! -d "${wrksrc}" ] && neko_msg warning "No source found, re-downloading..." && for step in fetch extract patch build
			do
				do_${step} "${2}"
			done || { cd "${wrksrc}" || exit 1; }
		do_uninstall "${2}"
		;;
	*)
		neko_msg error "Unknown option \"${1}\"" && exit 1
		;;
esac
